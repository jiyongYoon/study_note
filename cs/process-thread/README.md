# Process & Thread

## 컴퓨터로 어플리케이션을 실행하면 어떤 일이 일어나는가?

컴퓨터는 크게 `CPU`, `Memory`, `Disk` 총 3가지로 구성되어 있다.
처음 컴퓨터를 켜면 운영체제(OS)가 디스크로부터 불러와져서 메모리에 올라가게 된다.
이 운영체제는 컴퓨터 자원 전반의 상호작용을 관리하게 된다.

기본적으로 우리가 설치하게 되는 프로그램이나 파일 등은 디스크에 저장이 되어 있다.
프로그램을 실행하게 되면 운영체제는 디스크에 있는 프로그램을 메모리로 올려 프로그램의 `인스턴스`, 우리가 잘 아는 `프로세스`의 형태로 실행하게 된다.
이 프로세스는 다른 프로세스와는 완전히 별개인 하나의 프로세스로 존재하게 된다.

<img src="https://github.com/jiyongYoon/study_cs_note/assets/98104603/403180ed-7018-4c7a-a280-af4cad218d78" alt="adder" width="70%" />

프로세스안에는 프로세스가 공유하는 `파일`, `코드`, `데이터(Heap)`가 있고, 각 스레드의 고유 영역인 `스택`, `레지스터`, `프로그램카운터` 등이 있다.
스택은 메모리 영역으로, 지역변수가 저장되고 기능이 실행되는 영역이다.
프로그램카운터는 다음 명령어의 주소를 가리키는 역할을 한다.

## 컨텍스트 스위칭

CPU는 최소 한개 이상의 코어를 가지며, 코어는 최소 한개 이상의 프로세스를 가지고, 프로세스는 최소 한개 이상의 스레드를 가신다. (실제로는 코어 한 개당 수십, 수백개의 프로세스를 동작하며, 프로세스는 또 수많은 스레드를 가진다)

보통 프로그램을 실행하면 프로그램 하나 당 하나의 프로세스가 할당되게 된다.

운영체제는 이 CPU 자원을 활용하여 작업단위인 스레드를 하나씩 실행한다. 이 때, 하나를 계속 동작시키는 것이 아니라 스케쥴링을 통해 여러 스레드를 계속 바꿔가며 작업을 진행하는데, 이렇게 작업 흐름이 바뀌는 것이 `컨텍스트 스위칭`이다.

병렬 처리를 위해 이렇게 작업을 하는데, 그 대신 스위칭 비용이 발생하게 된다. (기존 작업 내용을 저장하고, 새로운 스레드 혹은 프로세스를 갈아타게 되기도 하는 등) 이런 스위칭이 많이 일어나게 되면 작업보다 스위칭에 더 많은 비용이 발생하는데, 이를 `컨텍스트 스위칭 오버헤드`이라고 한다.

컨텍스트 스위칭은 다른 프로세스의 두 스레드 간에 발생하는 것 보다, 같은 프로세스 간에 발생하는 것이 더 효율적이다. 기존에 사용했던 프로세스 내 공유공간(파일, 코드, 힙(데이터)) 영역을 활용할 수 있기 때문이다.

어떤 스레드작업을 언제 실행할지는 스케쥴링 알고리즘에 따라 달라지게 된다.

### 컨텍스트 스위칭의 실제 위치와 주체

실제 위치는 CPU(하드웨어)에서 일어나는 일이다. CPU의 레지스터(프로그램 카운터, 스택 포인터 등)가 현재 작업상태를 저장하고 새로운 작업 상태로 교체되는 과정이 하드웨어 수준에서 실행되는 것을 이야기한다.
하지만 이 과정을 언제 어떻게 할지는 운영체제(소프트웨어)가 결정하고 관리한다. 작업 상태를 저장할 메모리 위치를 지정하고, 다음 작업 상태를 로드하는 명령을 보내는 등의 역할을 한다.

## 여러 작업을 병렬로 처리하기 위해서는?

크게 두 가지 방법이 있을 것이다.

**1. 멀티 프로세스** <br>
**2. 멀티 스레드**

멀티 프로세스는 자원을 공유하지 않기 때문에 멀티 스레드보다 보안에 좋고 안정성이 높다. 또, 하나의 프로세스가 다운되어도 다른 프로세스가 동작하여 앱 전체가 다운되지 않는다.
반면, 멀티 스레드는 생성비용이 프로세스보다 적고, 공유하는 자원이 많기 때문에 병렬 처리에 더욱 특화되어 있다. 또, 앱 전체가 스레드 하나에 다운될 가능성 있다.

---

## 스레드의 하드웨어적 관점 vs 소프트웨어적 관점

### 하드웨어적 스레드

CPU가 작업을 처리하는 단위라고 생각하면 되는데, `멀티스레딩(Multithreading)`이라는 개념으로 이해하면 된다.
하나의 CPU 코어가 동시에 여러 작업(스레드)을 처리할 수 있게 해주는 기술이다. (e.g. 인텔의 '하이퍼스레딩')

[명령어 파이프라인](/cs/fast-campus/컴퓨터구조/4.%20CPU/README.md)에서 작업을 잘 채워넣어 코어의 효율을 높이는 방식으로 사용할 수 있다.
예를 들어, 한 스레드가 메모리에서 데이터를 기다리는 동안 다른 스레드가 계산을 하는 식으로 말이다.

### 소프트웨어적 스레드

하나의 프로그램(프로세스)이 여러 일을 동시에 할 수 있게 해주는 `작업 줄기`라고 생각하면 된다.
운영체제가 관리하는 추상적 개념으로, 사용자(개발자)가 코드를 사용해 스레드를 지정하면, 운영체제가 그 스레드를 CPU에 할당해서 사용하게 된다.

소프트웨어적 스레드는 실제 어떤 하드웨어 요소(코어인지, 스레드인지)가 날 동작시키고 있는지 알 수 없다. (관심사가 아니다)

> CPU를 이야기할때 보통 `4코어 12스레드` 와 같은 용어를 사용한다.
> `코어`는 CPU 구성요소(ALU, 제어장치, 레지스터들) 세트 갯수를 이야기하고,
> `스레드`는 한 코어 내에서 하이퍼스레딩을 통해 해당 CPU에서 총 사용할 수 있는 전체 스레드 갯수를 이야기 한다고 이해하면 된다.

---

### 함께 볼 내용들

- [프로세스와 스레드](/cs/fast-campus/운영체제/2.%20프로세스와%20스레드/README.md)
- [CPU와 Process, Thread](/cs/null-null-developer/2.%20곰책으로%20쉽게%20배우는%20최소한의%20운영체제론/2.%20CPU와%20Process,%20Thread/README.md)
- [CPU](/cs/fast-campus/컴퓨터구조/4.%20CPU/README.md)