이 글은 집에 미니PC로 홈 서버를 세팅한 내용을 간단하게 정리한 글입니다.

# 미니PC 윈도우 재설치, 네트워크 세팅과 OpenSSH 서버 설치, WSL 설치, 포트 바인딩

---

집에 서버 하나들 두고 싶은 마음이 항상 있었다. (AWS 요금 무서운건 안비밀)
알리에서 싸게 `FIREBAT AK2플러스 인텔N100 미니PC`를 하나 장만을 하였고, 기쁜 마음에 wsl을 설치하려고 했는데, 시행착오가 있었다.
이럴 때는 윈도우부터 다시 세팅해주는게 진리다...

- 미니PC 스펙
  - CPU: intel n100
  - RAM: 16GB 온보드
  - SSD: 512GB

> 앞으로의 글에서 미니PC는 `서버`라고도 호칭하겠다.

## 1) 윈도우 재설치

- [집연구소: 윈도우 재설치 영상](https://youtu.be/yyN8eE-kN0A?si=SyZqiOUqZWF61Rlr)

영상을 그대로 따라갔다. 윈도우 인증키와 설치된 드라이버까지 백업받아 깔끔하고 빠르게 설치할 수 있어서 좋았다.
(중국 제품에서 악성 코드 이슈도 있다고 하니... 조금 귀찮더라도 처음에 하는게 좋을 수 있다는 생각이다..!)

## 2) 네트워크 세팅과 OpenSSH 서버 설치

자고로 미니PC의 강력함은 작은 크기지 않을까. PC를 tv 뒤쪽으로 숨겨주고, 책상의 데스크탑에서 원격으로 접속하고 싶다. (당연히 그래야 한다!!)

GUI 툴을 사용할 필요가 가끔 있는 경우도 있고, 무엇보다 초반 세팅은 GUI를 함께 활용하는게 더 쉽고 빠르다.
나는 아래 프로그램을 사용한다. (teamviewer, google 크롬 원격 데스크톱 등 여러가지가 있으니 취향껏 검색해서 사용해보자.) 

- [Rustdesk](https://rustdesk.com/ko/)

ssh 터널링 등의 기능도 제공하는 것 같은데, 그보다 윈도우에서 자체적으로 제공하는 ssh 기능을 사용하려고 한다.

그 전에, 먼저 서버의 ip를 알아야 한다. GUI 툴로 들어가서 서버에서 powershell을 열어 `ipconfig` 명령어로 ip를 확인해보자.

나는 서버 인터넷을 와이파이 모듈로 잡았기 때문에 `무선 LAN 어뎁터 Wi-Fi` 부분의 주소를 보면 된다.

- ipconfig 예시
    ```
    PS C:\Users\jyyoon_mini> ipconfig
    
    Windows IP 구성
    
    
    이더넷 어댑터 이더넷:
    
       미디어 상태 . . . . . . . . : 미디어 연결 끊김
       연결별 DNS 접미사. . . . :
    
    무선 LAN 어댑터 로컬 영역 연결* 1:
    
       미디어 상태 . . . . . . . . : 미디어 연결 끊김
       연결별 DNS 접미사. . . . :
    
    무선 LAN 어댑터 로컬 영역 연결* 10:
    
       미디어 상태 . . . . . . . . : 미디어 연결 끊김
       연결별 DNS 접미사. . . . :
    
    무선 LAN 어댑터 Wi-Fi:
    
       연결별 DNS 접미사. . . . :
       IPv6 주소 . . . . . . . . . : fd31:6fc4:5caa:133:abed:ffd2:abf2:c3f6
       임시 IPv6 주소. . . . . . . : fd31:6fc4:5caa:133:1133:8e8d:8696:6794
       링크-로컬 IPv6 주소 . . . . : fe80::4ad5:729a:bc1a:9a3%13
       IPv4 주소 . . . . . . . . . : 192.168.0.48   <--- 이게 서버의 사설 ip
       서브넷 마스크 . . . . . . . : 255.255.255.0
       기본 게이트웨이 . . . . . . : 192.168.0.1     <--- 이건 서버가 포함된 네트워크의 맨 앞단 ip (공유기)
    
    이더넷 어댑터 Bluetooth 네트워크 연결:
    
       미디어 상태 . . . . . . . . : 미디어 연결 끊김
       연결별 DNS 접미사. . . . :
    
    이더넷 어댑터 vEthernet (Default Switch):
    
       연결별 DNS 접미사. . . . :
       링크-로컬 IPv6 주소 . . . . : fe80::e5d1:18d2:5646:1970%33
       IPv4 주소 . . . . . . . . . : 172.31.0.1
       서브넷 마스크 . . . . . . . : 255.255.240.0
       기본 게이트웨이 . . . . . . :
    
    이더넷 어댑터 vEthernet (WSL (Hyper-V firewall)):
    
       연결별 DNS 접미사. . . . :
       링크-로컬 IPv6 주소 . . . . : fe80::4b1:7a4b:d24f:5339%50
       IPv4 주소 . . . . . . . . . : 172.19.144.1
       서브넷 마스크 . . . . . . . : 255.255.240.0
       기본 게이트웨이 . . . . . . :
    ```

요청하는 클라이언트는 OpenSSH 클라이언트 버전이 설치되어 있어야 하고, 요청을 받는 서버는 OpenSSH 서버 버전이 설치되어 있어야 한다.
클라이언트 버전은 모든 윈도우에 기본 설치되어 있는 것 같다.
미니PC에는 서버 버전을 추가로 설치하면 된다.

- [블로그: OpenSSH 설치가 잘 정리된 글](https://eehoeskrap.tistory.com/763)

혹시 OpenSSH 설치가 잘 되었더라도 연결이 안되는 경우에는 네트워크가 하나의 공인 ip로 묶여있는지 확인을 해보길 바란다.

간단히 말하면, 우리는 SKT, KT, LGU+ 와 같은 ISP(Internet Service Provider)에 돈을 내고 인터넷을 쓰는데, 
거기서는 우리에게 하나의 공인 ip(인터넷 세계에서 우리집을 인터넷 연결을 식별하는 주소)를 할당해준다.
때문에 우리가 가진 단말기(핸드폰, PC, 여러 가전기기 등)가 하나의 공인 ip 아래에 속해야 접근이 편해진다. 

다른 집의 인터넷에 접근하지 못하는 것이 당연하다. 이는 기본적으로 보안규칙에 의해서 막혀있는데, 
하나의 홈 네트워크로 구성이 되지 않으면 물리적으로 우리집이더라도 ip상으로는 다른 범위로 묶이게 될 수도 있기 때문이다.

이 부분은 집집마다 환경이 매우 다르기 때문에 잘 정리된 영상을 보면서 준비해보면 더 좋다.

- [서울리안: 홈 네트워크 구성하기 영상](https://youtu.be/FxGQ1le-Si8?si=EAqSF9OKlysJ3GLE)

## 3) WSL 설치

WSL은 microsoft에서 리눅스를 편하게 사용할 수 있게 제공해주는 간편한 가상환경이다. 기존에 가상머신(VMWare, VirtualBox 등)을 사용해서 세팅해야했던 것을 더 원활하고 가볍게 설치해서 사용할 수 있게 해준다.
나는 서버에 다른 프로그램을 설치하지는 않고 대부분을 `Container`라는 가상화 기술을 사용할 예정이다. 대표적으로 `Docker Container`가 있다.
윈도우 운영체제에서 Container 사용을 위해 WSL 설치가 필수적이다. 

이 기능으로 인해 `개발자는 무조건 맥북이지`에서 많이 벗어날 수 있게 되었을 것 같다. (윈도우 10이 출시하고 1년 후에 발표한거다 보니, 진짜 얼마 되지 않았다!)

- [위키독스: 설치 전 세팅을 포함한 설치 방법](https://wikidocs.net/219899)
- [microsoft 공식: WSL 설명 및 설치](https://learn.microsoft.com/ko-kr/windows/wsl/about)

## 4) 포트 바인딩

사용하고자 하는 프로그램에 따라 포트를 바인딩해야하는 경우가 있을 것이다.
WSL을 설치한 후 nginx 이미지를 사용해 컨테이너를 띄워 클라이언트에서 접속해보았는데, 웬걸 접속이 안된다.

당연히 WSL이 의심이 갔고, 윈도우 하위에 리눅스 시스템을 운용하는 것이기 때문에 WSL은 따로 가상 ip 같은걸 사용할 것이라고 생각되었다.
찾아보니까 그러했다...

즉, 서버의 Window와 서버의 WSL을 연결해주는 작업이 한번 더 있어야 했다.

- [위키독스: WSL 배포에 SSH 서버 구성](https://wikidocs.net/219898)
- [블로그: 외부 기기에서 WSL에 설치된 OS에 접속 설정](https://blog.naver.com/islove8587/223430875037)

윈도우 방화벽을 열어주고 `netsh`를 사용해 포트포워딩을 하는 방법은 동일했는데, 아래 블로그에서는 WSL 부팅 시 동적일 수 있는 private ip를 동적으로 할당받아서 자동화 처리되도록 스크립트를 생성해서 돌린다.
좋은 방법인것 같기도 하다. 일단 나는 서버를 띄운 다음에는 직접 해줄 생각이라 pass

- `netsh`를 사용한 포트포워딩
  ```shell
  netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=8080 connectaddress=172.19.152.205  
  ```

- `netsh` 포트포워딩 종료
  ```shell
  netsh interface portproxy delete v4tov4 listenport=8080 listenaddress=0.0.0.0
  ```

- `netsh` 포트포워딩 상태 확인
  ```shell
  netsh interface portproxy show all
  ```

  ```text
  ipv4 수신 대기:             ipv4에 연결:
  
  주소            포트        주소            포트
  --------------- ----------  --------------- ----------
  0.0.0.0         8080        172.19.152.205  8080
  ```

이제 미니PC의 ip:port 로 요청을 하면 포트포워딩이 되어 WSL로 요청이 가게 된다!
오예

---

네트워크에 대한 복습을 다시 할 수 있어서 좋았다.
이제, 개인적으로 사용할 애플리케이션들을 좀 띄워서 사용해보아야겠다.